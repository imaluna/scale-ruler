!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).ScaleRuler=e()}(this,(function(){"use strict";function t(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function e(t,e,n){return function(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,i(a.key),a)}}(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function n(e,n){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,n){if(e){if("string"==typeof e)return t(e,n);var i={}.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?t(e,n):void 0}}(e))||n){i&&(e=i);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,l=!0,s=!1;return{s:function(){i=i.call(e)},n:function(){var t=i.next();return l=t.done,t},e:function(t){s=!0,r=t},f:function(){try{l||null==i.return||i.return()}finally{if(s)throw r}}}}function i(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t,"string");return"symbol"==typeof e?e:e+""}var a=function(t){return"object"===function(t){return Object.prototype.toString.call(t).slice(8,-1).toLowerCase()}(t)},o=function(t,e){var n={};for(var i in t)i in e?a(t[i]&&a(e[i]))?n[i]=o(t[i],e[i]):n[i]=e[i]:n[i]=t[i];for(var r in e)r in t||(n[r]=e[r]);return n},r=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return+t.toFixed(e)},l={scale:1,maxScale:10,minScale:.1,autoCenter:!0,autoScale:1,containerAutoSize:!1,width:1e3,height:500,padding:80,verticalPadding:void 0,horizontalPadding:void 0,canvasWidth:1920,canvasHeight:2e3,proxyScaleKey:!0,showScrollBar:!0,showRuler:!0,usePositionLine:!0,positionLineConfig:{lineColor:"#24aa61",padding:3,adsorptionXList:[],adsorptionYList:[]},canvasStyle:{},scrollConfig:{backgroundColor:"#000000",opacity:.4},rulerConfig:{verticalRulerWidth:30,horizontalRulerHeight:30,bgColor:"#efefef",fontColor:"#000000",fontSize:12,fontFamily:"Arial",lineColor:"#000000"},onScale:function(){},onMove:function(){}};Object.freeze(l);var s=function(){return e((function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._init(e)}),[{key:"_init",value:function(t){if(!a(t))throw TypeError("options必须为对象");var e=o(l,t);this._checkOptions(e),e.containerConfig={},e.canvasConfig={},this.opt=e,this._initContainer(),this._initCanvas(),e.proxyScaleKey&&document.addEventListener("keydown",this._keydownEvent),e.showScrollBar&&(e.wheelTimer=null)}},{key:"_checkOptions",value:function(t){if(!t.el)throw Error("容器不能为空");var e=t.el instanceof HTMLElement?t.el:document.querySelector(t.el);if(!e)throw Error(t.el+"容器不存在");if(!document.body.contains(e)&&!document.documentElement.contains(e))throw Error("页面上不存在该容器");t.containerEl=e;var n=t.minScale,i=t.maxScale;if(n<=0)throw Error("minScale必须大于0");if(i<=0)throw Error("maxScale必须大于0");if(i<n)throw Error("minScale不能大于maxScale")}},{key:"_keydownEvent",value:function(t){var e=t.keyCode;if((t.metaKey||t.ctrlKey)&&(187===e||189===e)){t.preventDefault();var n=this.opt.scale+(187===e?.05:-.05);this.changeScale(n)}}},{key:"changeScale",value:function(t){var e=this.opt,n=e.scale,i=e.canvasConfig,a=i.translateX,o=i.translateY,r=(t=Math.min(Math.max(t,e.minScale),e.maxScale))-n;e.scale=t;var l=e.canvasWidth*t,s=e.canvasHeight*t;this._setTranslateBoundary(l,s),a-=r*e.canvasWidth/2,o-=r*e.canvasHeight/2,a=Math.max(Math.min(a,i.maxTranslateX),i.minTranslateY),o=Math.max(Math.min(o,i.maxTranslateY),i.minTranslateY),this._transform(a,o),"function"==typeof e.onScale&&e.onScale(e.scale),this._checkLarge()}},{key:"_setTranslateBoundary",value:function(t,e){var n=this.opt,i=n.width,a=n.height,o=n.horizontalPadding,r=n.verticalPadding,l=Math.max((i-t)/2,o),s=Math.max((a-e)/2,r),c=t+2*o>i?i-(t+o):l,d=e+2*r>a?a-(e+r):s;n.canvasConfig.maxTranslateX=l,n.canvasConfig.maxTranslateY=s,n.canvasConfig.minTranslateX=c,n.canvasConfig.minTranslateY=d}},{key:"_initContainer",value:function(){var t,e,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=this.opt;i.containerAutoSize?(t=parseFloat(i.containerEl.offsetWidth),e=parseFloat(i.containerEl.offsetHeight),i.containerConfig.originWidth=t,i.containerConfig.originHeight=e,i.addResize||this._onContainerResize()):(t=i.width,e=i.height,i.containerEl.style.width=t+"px",i.containerEl.style.height=e+"px");var a=getComputedStyle(i.containerEl);"border-box"===a.boxSizing&&(t-=parseFloat(a.borderLeftWidth)+parseFloat(a.borderRightWidth),e-=parseFloat(a.borderTopWidth)+parseFloat(a.borderBottomWidth)),i.width=t,i.height=e,"static"===a.position&&(i.containerEl.style.position="relative"),i.horizontalPadding=i.horizontalPadding||i.padding,i.verticalPadding=i.verticalPadding||i.padding,i.containerEl.style.overflow="hidden",i.showRuler&&this._initRuler(n)}},{key:"_onContainerResize",value:function(){var t=this,e=this.opt,i=e.containerEl,a=e.containerConfig;a.addResize=!0,new ResizeObserver((function(e){var o,r=n(e);try{for(r.s();!(o=r.n()).done;){if(o.value.target===i){var l=i.offsetWidth,s=i.offsetHeight;l===a.originWidth&&s===a.originHeight||(t._initContainer(!0),t._initCanvas(!0))}}}catch(t){r.e(t)}finally{r.f()}})).observe(i)}},{key:"_repaintRuler",value:function(t){var e=this.opt,n=e.rulerConfig,i=e.canvasConfig,a=e.scale,o=t?e.vCtx:e.hCtx,r=t?n.verticalRulerWidth:n.horizontalRulerHeight,l=t?r:e.width,s=t?e.height:r;o.clearRect(0,0,l,s);var c=i.translateX,d=i.translateY,h=t?d:c;o.save(),o.fillStyle=n.bgColor,o.fillRect(0,0,l,s),o.restore();var u=function(t){return t<=.25?40:t<=.5?20:t<=1?10:t<=2?5:t<=4?2:1}(a),f=u*a,v=window.devicePixelRatio,p=-h,g=Math.floor(p/f),y=Math.floor(((t?s:l)-h)/f);o.save(),o.fillStyle=n.lineColor,o.font="".concat(n.fontSize*v,"px ").concat(n.fontFamily),o.translate(.5,.5),o.scale(1/v,1/v),t?o.fillRect((r-1)*v,0,1,s*v):o.fillRect(0,(r-1)*v,l*v,1);for(var m=g;m<=y;m++){o.fillStyle=n.lineColor;var C=(h+m*f)*v,E=r/4;m%10==0?E=4*r/5:m%5==0&&(E=r/3),t?o.fillRect((r-E)*v,C,E*v,1):(o.fillRect(C,(r-E)*v,1,E*v),m%10==0&&(o.fillStyle=n.fontColor,o.fillText(String(m*u),C+2*v,(r+8-E)*v)))}if(o.restore(),t){o.font="".concat(n.fontSize,"px ").concat(n.fontFamily);for(var b=g;b<=y;)if(b%10)b++;else{o.save();var x=h+b*f+r/2;o.translate(x+r/5,x-6*r/5),o.rotate(Math.PI/2),o.fillText(String(b*u),4*r/5,x),b+=10,o.restore()}}}},{key:"_initRuler",value:function(){var t=this.opt,e=t.rulerConfig;t.hRuler||(t.hRuler=this._createRuler(!1),t.hCtx=t.hRuler.getContext("2d")),t.vRuler||(t.vRuler=this._createRuler(!0),t.vCtx=t.vRuler.getContext("2d")),t.hRuler.setAttribute("width",t.width),t.hRuler.setAttribute("height",e.horizontalRulerHeight),t.vRuler.setAttribute("height",t.height),t.vRuler.setAttribute("width",e.verticalRulerWidth)}},{key:"_createRuler",value:function(t){var e=this.opt,n=document.createElement("canvas");return n.style.position="absolute",n.style.left=0,n.style.top=0,n.style.zIndex=t?100:101,e.containerEl.appendChild(n),e.usePositionLine&&this._initPositionLine(e,t,n),n}},{key:"_initPositionLine",value:function(t,e,n){var i=this,a=t.positionLineConfig,o=t.rulerConfig;a.id=a.id||0,a.lines=a.lines||{};var l=a.lineColor,s=a.padding,c=a.positionLineWrapEl;c||(c=document.createElement("div"),a.positionLineWrapEl=c,t.containerEl.appendChild(c));var d,h={top:(d=n.getBoundingClientRect()).top+(document.body.scrollTop||document.documentElement.scrollTop),left:d.left+(document.body.scrollLeft||document.documentElement.scrollLeft)},u=this;function f(e){if(o.isMouseDown){e.preventDefault();var n=a.currentNodeInfo;if(n){var i=n.positionEl,l=n.dir,s=n.tipEl,c=0;"y"===l?(i.style.visibility=e.pageY>h.top+o.horizontalRulerHeight?"visible":"none",c=e.pageY-h.top):(i.style.visibility=e.pageX>h.left+o.verticalRulerWidth?"visible":"none",c=e.pageX-h.left);var d=u._getCoordinate(t,l,c),f=u._checkAdSorptionLine(d,l,c);u._changeNodeTranslate(l,f.translate,i),n.translate=f.translate,n.coordinate=f.coordinate,s.innerHTML="".concat(l.toUpperCase(),": ").concat(r(f.coordinate)," px")}}}n.addEventListener("mousedown",(function(){o.isMouseDown=!0;var n=document.createElement("div"),r={position:"absolute",visibility:"hidden",backgroundColor:"transparent",zIndex:1e3},d=document.createElement("div"),u={position:"absolute",backgroundColor:l},v=document.createElement("div"),p={position:"absolute",padding:"5px",lineHeight:"18px",minWidth:"80px",backgroundColor:"rgba(0,0,0,.8)",color:"#fff",fontSize:"12px",borderRadius:"4px",userSelect:"none",textAlign:"center"},g="y";for(var y in e?(Object.assign(r,{width:2*s+1+"px",height:t.height+"px",cursor:"col-resize",top:0,left:-s+"px"}),Object.assign(u,{top:0,height:"100%",width:"1px",left:s+"px"}),Object.assign(p,{top:"50%",right:2*s+6+"px",transform:"translate(0, -50%)"}),g="x"):(Object.assign(r,{height:2*s+1+"px",width:t.width+"px",cursor:"row-resize",left:0,top:-s+"px"}),Object.assign(u,{left:0,width:"100%",height:"1px",top:s+"px"}),Object.assign(p,{left:"50%",bottom:2*s+6+"px",transform:"translate(-50%, 0)"})),r)n.style[y]=r[y];for(var m in u)d.style[m]=u[m];for(var C in p)v.style[C]=p[C];n.setAttribute("data-id",a.id),n.appendChild(d),n.appendChild(v),c.appendChild(n);var E={positionEl:n,id:a.id,tipEl:v,translate:0,dir:g};a.lines[a.id++]=E,a.currentNodeInfo=E,document.addEventListener("mousemove",f),document.addEventListener("mouseup",(function(t){if(o.isMouseDown){o.isMouseDown=!1;var e=a.currentNodeInfo;if(e){var n=e.positionEl,r=e.dir,l=e.tipEl,s=e.id,d="y"===r;!d&&t.pageX<=h.left+o.verticalRulerWidth||d&&t.pageY<=h.top+o.horizontalRulerHeight?(c.removeChild(n),delete a.lines[s]):(l.style.display="none",i._addPosisitionLineEvent(e,h))}a.currentNodeInfo=null,document.removeEventListener("mousemove",f)}}))}))}},{key:"_coordinateToTranslate",value:function(t,e){var n=this.opt,i=n.scale,a=n.canvasConfig,o=a.translateX,r=a.translateY;return("y"===e?r:o)+t*i}},{key:"_checkAdSorptionLine",value:function(t,e,n){var i=this.opt.positionLineConfig,a=i.adsorptionXList,o=i.adsorptionYList,r="y"===e?o:a,l={coordinate:t,translate:n},s=r.length;if(s>0)for(var c=0;c<s;){var d=r[c];if(Math.abs(t-d)<=2){l.coordinate=d,l.translate=this._coordinateToTranslate(d,e);break}if(d>t)break;c++}return l}},{key:"_addPosisitionLineEvent",value:function(t,e){var n=t.positionEl,i=t.tipEl,a=t.dir,o=this.opt,l=o.positionLineConfig,s=o.rulerConfig;n.addEventListener("mouseenter",(function(){i.style.display="block"})),n.addEventListener("mouseleave",(function(){i.style.display="none"})),n.addEventListener("mousedown",(function(e){e.preventDefault(),l.isMouseDown=!0,t.start="y"===a?e.pageY:e.pageX,t.originTranslate=t.translate,t.tipEl.style.display="block",l.currentNodeInfo=t,document.addEventListener("mousemove",d)}));var c=this;function d(t){if(l.isMouseDown){t.preventDefault();var e=l.currentNodeInfo,n=e.dir,i=e.tipEl,a=e.start,o=e.originTranslate,s=void 0===o?0:o,d=e.positionEl,h=s+(("y"===n?t.pageY:t.pageX)-a),u=c._getCoordinate(c.opt,n,h),f=c._checkAdSorptionLine(u,n,h);c._changeNodeTranslate(n,f.translate,d),e.translate=f.translate,e.coordinate=f.coordinate,i.innerHTML="".concat(n.toUpperCase(),": ").concat(r(f.coordinate)," px")}}document.addEventListener("mouseup",(function(t){if(l.isMouseDown){l.isMouseDown=!1;var n=l.currentNodeInfo;if(n){var i=n.positionEl,a=n.dir,o=n.id,r="y"===a;!r&&t.pageX<=e.left+s.verticalRulerWidth||r&&t.pageY<=e.top+s.horizontalRulerHeight?(i.parentNode.removeChild(i),delete l.lines[o]):(delete n.originTranslate,delete n.start)}l.currentNodeInfo=null,document.removeEventListener("mousemove",d)}}))}},{key:"_getCoordinate",value:function(t,e,n){var i=t.scale,a=t.canvasConfig,o=a.translateX,r=a.translateY;return(n-("y"===e?r:o))/i}},{key:"addAdsortptionLine",value:function(t){var e=this.opt.positionLineConfig,n=e.adsorptionXList,i=e.adsorptionYList;t.forEach((function(t){var e=t.dir,a=t.value;"y"===e?i.includes(a)||i.push(a):n.includes(n)||n.push(a)})),n.sort((function(t,e){return t-e})),i.sort((function(t,e){return t-e}))}},{key:"_initCanvas",value:function(){var t=this.opt,e=t.canvasEl;e||((e=document.createElement("div")).style.width=t.canvasWidth+"px",e.style.height=t.canvasHeight+"px",e.style.position="absolute",e.style.left=0,e.style.top=0,e.style.transition="transform 300ms",e.style.transformOrigin="0 0",t.canvasEl=e,this.addAdsortptionLine([{value:t.canvasWidth,dir:"x"},{value:0,dir:"x"},{value:0,dir:"y"},{value:t.canvasHeight,dir:"y"}]),t.containerEl.appendChild(e),t.containerEl.addEventListener("mousewheel",this._mousewheelEvent.bind(this)));var n=t.scale,i=t.autoScale,o=t.autoCenter;if(i){var r=(t.width-2*t.horizontalPadding)/t.canvasWidth,l=(t.height-2*t.verticalPadding)/t.canvasHeight;n=Math.min(r,l)}var s=0,c=0,d=t.canvasWidth*n,h=t.canvasHeight*n;if(o&&(s=Math.floor((t.width-d)/2),c=Math.floor((t.height-h)/2)),this._setTranslateBoundary(d,h),t.scale=n,a(t.canvasStyle))for(var u in t.canvasStyle)t.canvasEl.style[u]=t.canvasStyle[u];this._transform(s,c,!0),this._checkLarge()}},{key:"_transform",value:function(t,e){var n=this.opt,i=n.scale,a=n.canvasConfig;n.canvasEl.style.transform="translate(".concat(t,"px, ").concat(e,"px) scale(").concat(i,")");var o=t-a.translateX,r=e-a.translateY;a.translateX=t,a.translateY=e,n.showRuler&&(this._repaintRuler(!1),this._repaintRuler(!0)),n.usePositionLine&&this._changeLinesTranslate(o,r)}},{key:"_checkLarge",value:function(){var t=this.opt,e=t.scale,n=t.canvasConfig,i=t.containerConfig,a=t.showScrollBar,o=t.scrollConfig,r=n.translateX,l=n.translateY,s=t.canvasWidth*e+2*t.horizontalPadding,c=t.canvasHeight*e+2*t.verticalPadding;n.totalWidth=s,n.totalHeight=c;var d=t.width<s,h=t.height<c;if(i.isLarge=d||h,i.isXLarge=d,i.isYLarge=h,a){var u="none",f="none";if(d){f="block",t.hScrollBar||(t.hScrollBar=this._createScollBar(!1));var v=t.horizontalPadding-r;t.hScrollBar.style.left=t.width*(v/s)+"px";var p=t.width/s*t.width;t.hScrollBar.style.width=p+"px",o.width=p}if(t.hScrollBar&&(t.hScrollBar.style.display=f),h){t.vScollBar||(t.vScollBar=this._createScollBar(!0)),u="block";var g=t.verticalPadding-l;t.vScollBar.style.top=t.height*(g/c)+"px";var y=t.height/c*t.height;t.vScollBar.style.height=y+"px",o.height=y}t.vScollBar&&(t.vScollBar.style.display=u)}}},{key:"_changeNodeTranslate",value:function(t,e,n){var i="y"===t?"0, ".concat(e,"px"):"".concat(e,"px, 0");n.style.transform="translate(".concat(i,")")}},{key:"_changeLinesTranslate",value:function(t,e){var n=this,i=this.opt.positionLineConfig.lines;Object.keys(i).forEach((function(a){var o=i[a],r=o.dir,l=o.positionEl,s=o.translate;s+="y"===r?e:t,n._changeNodeTranslate(r,s,l),o.translate=s}))}},{key:"_mousewheelEvent",value:function(t){var e=this;if(t.preventDefault(),t.metaKey||t.ctrlKey){var n=-1*t.deltaY/100,i=this.opt.scale+n;this.changeScale(i)}else{var a=this.opt,o=a.scrollConfig,r=a.containerConfig,l=a.canvasConfig,s=a.hScrollBar,c=a.vScollBar;if(!r.isLarge||o.isDown)return;t.preventDefault(),this.opt.wheelTimer&&clearTimeout(this.opt.wheelTimer);var d=-t.deltaX,h=-t.deltaY,u="",f=this.opt.scrollConfig.opacity,v=void 0===f?.4:f,p=l.translateX,g=l.translateY;if(r.isXLarge&&Math.abs(d)>Math.abs(h)){u="h",p+=d,p=Math.max(Math.min(p,l.maxTranslateX),l.minTranslateX);var y=this.opt.horizontalPadding-p;s.style.opacity=v,c&&(c.style.opacity=0),s.style.left=this.opt.width*(y/l.totalWidth)+"px",this._transform(p,g),this.onMove(p,g)}if(r.isYLarge&&Math.abs(h)>Math.abs(d)){u="v",g+=h,g=Math.max(Math.min(g,l.maxTranslateY),l.minTranslateY),c.style.opacity=v,s&&(s.style.opacity=0);var m=this.opt.verticalPadding-g;c.style.top=this.opt.height*(m/l.totalHeight)+"px",this._transform(p,g),this.onMove(p,g)}u&&(this.opt.wheelTimer=setTimeout((function(){e.opt.scrollConfig.isMouseEnter||(("h"===u?s:c).style.opacity=0)}),1e3))}}},{key:"onMove",value:function(t,e){"function"==typeof this.opt.onMove&&this.opt.onMove(t,e)}},{key:"_createScollBar",value:function(t){var e=this.opt,n=e.scrollConfig,i=this,a=document.createElement("div"),o={position:"absolute",display:"none",borderRadius:"4px",backgroundColor:"#000000",opacity:0,transition:"opacity 300ms",cursor:"pointer",zIndex:200};for(var r in t?(o.right=0,o.width="8px"):(o.bottom=0,o.height="8px"),o)a.style[r]=o[r];var l=function(n){if(n.preventDefault(),e.scrollConfig.isDown){var o=e.scrollConfig,r=e.canvasConfig,l=r.translateX,s=r.translateY;if(t){var c=n.pageY-o.startY,d=o.top+c;d=Math.min(Math.max(0,d),e.height-o.height),a.style.top=d+"px";var h=d*r.totalHeight/e.height;s=e.verticalPadding-h}else{var u=n.pageX-o.startX,f=o.left+u;f=Math.min(Math.max(0,f),e.width-o.width),a.style.left=f+"px";var v=f*r.totalWidth/e.width;l=e.horizontalPadding-v}i._transform(l,s),i.onMove(l,s)}};return a.addEventListener("mouseenter",(function(){n.isMouseEnter=!0,a.style.opacity=n.opacity,t?n.hScrollBar&&(n.hScrollBar.style.opacity=0):n.vScrollBar&&(n.vScrollBar.style.opacity=0)})),a.addEventListener("mouseleave",(function(){n.isDown||(n.isMouseEnter=!1,a.style.opacity=0)})),a.addEventListener("mousedown",(function(e){n.isDown=!0,t?(n.startY=e.pageY,n.top=parseFloat(this.style.top)):(n.left=parseFloat(this.style.left),n.startX=e.pageX),document.addEventListener("mousemove",l)})),document.addEventListener("mouseup",(function(){n.isDown=!1,n.isMouseEnter=!1,document.removeEventListener("mousemove",l)})),e.containerEl.appendChild(a),a}},{key:"getCanvasEl",value:function(){return this.opt.canvasEl}},{key:"update",value:function(t){this._init(t,!0)}}])}();return s}));
